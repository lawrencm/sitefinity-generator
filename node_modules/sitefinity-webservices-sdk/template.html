<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
</head>
<body>
    <script>

        function clearHtmlMessages() {
            document.getElementById("message").innerHTML = "";
            document.getElementById("container").innerHTML = "";
            document.getElementById("containerErr").innerHTML = "";
        }

        window.onload = function () {

            var links = document.getElementsByTagName('input');

            for (var i = 0; i < links.length; i++) {
                if(links[i].hasAttribute("onclick"))
                 links[i].addEventListener('click', clearHtmlMessages, false);
            };

        }

        var query = new Sitefinity.Query();

        var query0 = query.where().and().endsWith("Title", "Record").done().or().startsWith('Title', 'asd').done().done();
        var query1 = query.where().or().endsWith("Record", "Title").ne('age', '15').eq('Content', 'test').done().done();
        var query2 = query.where().and().endsWith("Title", "Record").done().done();
        var query3 = query.where().endsWith("Record", "Title").or().ne('age', '15').eq('Content', 'test').done().done();
        var query4 = query.where().not().endsWith("Record", "Title").done().and().not().eq('Content', 'test').done().done().done();
        var query5 = query.where().not().and().endsWith("Record", "Title").eq('Content', 'test').done().done().done();
        var query6 = query.select("Id", "Title", "Content").expand('Tags').order("Title desc").where().ne('Title', 'zzz').eq('Title', 'newTitle').done()//.count();
        var query7 = query.order("Title desc").where().eq('Title', 'newTitleUPDATE1').done().select("Title", "Content");
        var query8 = query.where().eq('Title', 'newTitleN11').done();
        var query9 = query.where().eq('Title', null).done();
        var query10 = query.count();

        var queryIDs = query.select('Id');
        console.log(query0.build());
        console.log(query1.build());
        console.log(query2.build());
        console.log(query3.build());
        console.log(query4.build());
        console.log(query5.build());
        console.log(query6.build());
        console.log(query7.build());
        console.log(query8.build());
        console.log(query9.build());
        console.log(query10.build());
        //Create Item
        var newsItem = {
            "Title": 'newTitleN11',
            "UrlName": "newUrlName" + new Date().getTime(),
            "Content": "new content",
            "Summary": "new summary"
        };

        //Update Item
        var newsItemUpdate = {
            "Title": 'newTitleUPDATE!TEST'
        };

        var entitySet = "newsitems";

        var sitefinityUrl = "http://localhost"
        //Replace my_sandbox_location with the location of the server you are using
        var options = {
            serviceUrl: sitefinityUrl + "/api/default/",
            handlers: {
                failureCb: function() {
                    console.log("Global error occured");
                },
                successCb: function() {
                    console.log("Success executing request");
                }
            }
        }

        // operation data
        var action = {
            action: "Publish",
            actionParameters: {
                Title: "SomeTitle",
                PublicationDate: "2016-06-21T06:26:32.7439661Z",
                ExpirationDate: "2016-06-21T06:26:32.7439661Z"
            }
        };

        // Sitefinity object
        var sf = new Sitefinity(options);
        sf.authentication.setToken("");

        var inputElement = document.getElementById('getGuid');
        var that = this;
        // Success and Failure CB's
        var successCb = function (data) {
            document.getElementById("container").innerHTML = JSON.stringify(data);
        }

        var successCbBatch = function(data) {
            document.getElementById("container").innerHTML = JSON.stringify(data);
        }

        var failureCb = function (data) {
            if (data.status == 404) {
                document.getElementById("message").innerHTML = "You can use some of these items.";
                var data = sf.data(entitySet);
                data.get({
                    query: queryIDs,
                    successCb: successCb
                });
            }
            document.getElementById("containerErr").innerHTML = JSON.stringify(data.responseText);
        }

        var dataOptions = {
            urlName: entitySet,
            providerName: "OpenAccessDataProvider",
            cultureName: "en"
        }

        function requestGet() {
            var data = sf.data(dataOptions);
            data.get({
                query: null,
                successCb: successCb
            });
        }

        function requestGetCount(inline) {
            var data = sf.data(dataOptions);
            data.get({
                query: query.count(inline),
                successCb: successCb
            });
        }

        function requestGetSingle() {
            var data = sf.data(dataOptions);
            data.getSingle({
                key: getGuid(),
                query: null,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestGetRelated() {
            var data = sf.data(dataOptions);
            data.getRelated({
                key: getGuid(),
                navigationProperty: "Tags",
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestUpdate() {
            var data = sf.data(dataOptions);
            data.update({
                key: getGuid(),
                data: newsItemUpdate,
                //saveTemp: true,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestCreate() {
            var data = sf.data(dataOptions);
            data.create({
                data: newsItem,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestDelete() {
            var data = sf.data(dataOptions);
            data.destroy({
                key: getGuid(),
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestOperation() {
            var data = sf.data(dataOptions);

            data.operation({
                key: getGuid(),
                data: action,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestOperationAction() {
            var data = sf.data(dataOptions);

            data.getOperations({
                data: action,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestOperationActionSingle() {
            var data = sf.data(dataOptions);

            data.getOperations({
                key: getGuid(),
                data: action,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestCreateRelated() {
            var data = sf.data(dataOptions);
            var createRefLink = "http://localhost:8097/api/odata/flatTaxa(" + getRelatedGuid() + ")";
            data.createRelated({
                key: getGuid(),
                navigationProperty: "Tags",
                link: createRefLink,
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestDeleteRelated() {
            var data = sf.data(dataOptions);
            data.destroyRelated({
                key: getGuid(),
                navigationProperty: "Tags",
                successCb: successCb,
                failureCb: failureCb
            });
        }

        function requestBatch() {
            /*data.getProperty({
                key: id,
                property: "Title",
                successCb: successCb,
                failureCb: failureCb
            });

            data.getRelated({
                key: id,
                navigationProperty: "Tags",
                successCb: successCb,
                failureCb: failureCb
            });

           */

            var batch = sf.batch(successCbBatch, failureCb);

            batch.get({
                entitySet: entitySet,
                query: query8
            });

            var transaction = batch.beginTransaction();

            var createId = transaction.create({
                entitySet: entitySet,
                data: newsItem
            });

            batch.endTransaction(transaction);

            var transaction2 = batch.beginTransaction();

            var createId2 = transaction2.create({
                entitySet: entitySet,
                data: newsItem
            });

            var updateId2 = transaction2.update({
                entitySet: entitySet,
                saveTemp: true,
                key: createId2,
                data: newsItemUpdate
            });

            var operation2 = transaction2.operation({
                entitySet: entitySet,
                key: createId2,
                data: action
            });

            batch.endTransaction(transaction2);

            batch.get({
                entitySet: entitySet
            });

            batch.execute();
        }

        function upload() {
            /*
                Headers:
                Content-Type: image/jpeg
                Content-Encoding: base64
                in a changeset with Content-ID's
                first request is post with image binary data
                second is patch with content id of first and for data {Title: "" , UrlName: ""}
                third is post (create ref to the album) with content id of first, navigation property of the album and link to this album
                used parameters:
                1. entitySet of document/image/video
                2. binary data of the file
                3. additional data for the file
                2 and 3 can be combined in one data object as
                data {
                    file: file, // take content type from file.type
                    fileDescription: {fileDescription}
                }

                4. navigationProperty/library: ""
                5. link: "" to the album/library
            */

            /*
                Total 3 requests: UploadRequest, UpdateRequest, CreateRelationRequest
                Content-Type for create request is like Content-type: image/jpeg (file type).
            */

            var photo = document.getElementById("photo");
            var file = photo.files[0];

            var imageData = {
                "Title": file.name,
                "UrlName": file.name
            };
            var ready = false;
            var result = '';

            var that = this;
            var check = function () {
                if (ready === true) {
                    //encode to base64 from binary string
                    result = btoa(result)

                    var data = sf.data({
                        urlName: "images"
                    });
                    data.upload({  /* POST */
                        data: {
                            content: result, /* images, documents or videos */
                            contentType: "image/jpeg",
                            name: "test.jpg",
                            payload: {
                                Title: "Test",
                                UrlName: "test"
                            },
                            uploadProperties: {
                                ParentId: "4BA7AD46-F29B-4E65-BE17-9BF7CE5BA1FB"
                            }
                        },
                        successCb: successCb,
                        failureCb: failureCb
                    });

                    return;
                }
                setTimeout(check, 1000);
            }

            check();

            // read file
            var reader = new FileReader();
            reader.onloadend = function (event) {
                result = event.target.result
                ready = true;
            }

            reader.readAsBinaryString(file);
        }

        function getGuid() {
            var inputElement = document.getElementById('getGuid');
            return inputElement.value;
        }

        function getRelatedGuid() {
            var inputElement = document.getElementById('getRelatedGuid');
            return inputElement.value;
        }

        function login(username, password) {
            var url = sitefinityUrl + "/Sitefinity/Authenticate/OpenID/connect/token";
            var data = {
                username: username,
                password: password,
                grant_type: "password",
                scope: "openid",
                client_id: "iris",
                client_secret: "secret"
            };

            var body = "";
            Object.keys(data).forEach(key => {
                if (body.length) {
                    body += "&";
                }
                body += key + "=";
                body += encodeURIComponent(data[key]);
            });

            var xhr = new XMLHttpRequest();

            xhr.open("POST", url, true);
            xhr.addEventListener("load", () => {
                if (xhr.status == 200) {
                    let token = JSON.parse(xhr.responseText);

                    let tokenObj = {
                        type: token.token_type,
                        value: token.access_token
                    };

                    sf.authentication.setToken(tokenObj);
                }
            });

            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            xhr.send(body);
        }

    </script>
    Usage: <br /><code>
        <b>
            sf = new Sitefinity(options);<br />data = sf.data(entitySet);<br />data.get(); data.destroy ...
            <br />data.batch(successCb, failureCb).get().Update...done(); content id's starts from 0 to n ('get' is 0 'update' is 1 etc.).
        </b>
    </code><br /><br />
    <input type="button" value="login" onclick="login()" />
    <input type="button" value="requestGet" onclick="requestGet()" />
    <input type="button" value="requestGetCountInline" onclick="requestGetCount(true)" />
    <input type="button" value="requestGetCount" onclick="requestGetCount(false)" />
    <input type="button" value="requestGetSingle" onclick="requestGetSingle()" />
    <input type="button" value="requestGetRelated" onclick="requestGetRelated()" />
    <input type="button" value="requestUpdate" onclick="requestUpdate()" />
    <input type="button" value="requestCreate" onclick="requestCreate()" />
    <input type="button" value="requestCreateRelated" onclick="requestCreateRelated()" />
    <input type="button" value="requestDelete" onclick="requestDelete()" />
    <input type="button" value="requestDeleteRelated" onclick="requestDeleteRelated()" />
    <input type="button" value="requestBatch" onclick="requestBatch()" />
    <input type="button" value="requestOperation" onclick="requestOperation()" />
    <input type="button" value="requestOperationAction" onclick="requestOperationAction()" />
    <input type="button" value="requestOperationActionSingle" onclick="requestOperationActionSingle()" />
    <br />
    <br />
    <input type="text" id="getGuid" value="00000000-0000-0000-0000-000000000000" size="50" />
    <span>related ID</span><input type="text" id="getRelatedGuid" value="00000000-0000-0000-0000-000000000000" size="50" />
    <br />
    <br />
    <input type="file" name="photo" id="photo">
    <input type="button" value="Upload" onclick="upload()">
    <div id="some_container_div"></div>
    <br />
    <br />
    <div id="message" style="color: blue; border: 1px solid;"></div>
    <div id="container" style="color: green; border: 1px solid;"></div>
    <div id="containerErr" style="color: red; border: 1px solid;"></div>
</body>
</html>
